<section class="tree-menu">
    <input type="text" name="filter" data-tree-filter placeholder="Filter links" />
    <ul class="tree-root">
        {{- $here := .dir }}
        {{- range (readDir $here) }}
            {{ if in .Name "image" }}
            {{ else }}
                {{- $fullPath := (printf "%s%s" $here .Name) }}
                {{- $fullUrl := replace $fullPath "/content" "" }}
                {{- $stat := os.Stat $fullPath }}
                {{ if $stat.IsDir }}
                    {{- template "treemenu" dict "path" $fullPath "url" $fullUrl "root" $.root "depth" 1 }}
                {{ end }}
            {{ end }}
        {{- end -}}
    </ul>
</section>

{{ define "treemenu" }}
    {{ $nextDepth := add .depth 1 }}
    {{- $activeLink := $.root.Permalink }}
    {{- $className := "" }}
    {{- $deprecated := true }}
    {{- with $.root.Site.GetPage .url }}
        {{- if not .Params.deprecated }}
            {{- $deprecated = false }}
            {{- $branchLink := .Permalink }}
            {{- if in $activeLink $branchLink  }}
                {{- $className = "tree-branch-active" -}}
            {{ end }}
            {{- if eq $activeLink $branchLink  }}
                {{- $className = "tree-active tree-branch-active" -}}
            {{- end -}}
            <li data-depth="{{ $.depth }}" class="{{ $className }}">
                <span class="toggle-btn" data-toggle="tree-branch">[+]</span>
                <a href="{{ .Permalink }}">{{ .Title }}</a>
        {{- end }}
    {{- end }}
    {{- if not $deprecated }}
        <ul class="tree-branch" style="display:none;">
        {{- range (readDir .path) }}
            {{- if in .Name "image" | or (eq .Name "_index.md") }}
            {{- else }}
                {{- $fullPath := (printf "%s/%s" $.path .Name) }}
                {{- $fullUrl := replace $fullPath "/content" "" }}
                {{- $fullUrl = replace $fullUrl ".md" "" }}
                {{- $stat := os.Stat $fullPath }}
                {{- if $stat.IsDir }}
                    {{- template "treemenu" dict "path" $fullPath "url" $fullUrl "root" $.root "depth" $nextDepth }}
                {{- else }}
                    {{- with $.root.Site.GetPage $fullUrl }}
                        {{- $link := printf "%s" .Permalink }}  
                        <li{{- if in $activeLink $link }} class="tree-active"{{ end }}> 
                            <a href="{{ .Permalink }}">{{ .Title }}</a>
                        </li>
                    {{- end }}
                {{- end }}
            {{- end }}
        {{- end }}
        </ul>
    </li>
    {{- end }}
{{ end }}

<style>
    .toggle-btn {
        cursor: pointer;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggles = document.querySelectorAll('[data-toggle="tree-branch"]');
        const filterInput = document.querySelector('[data-tree-filter]');

        toggles.forEach(function(toggle) {
            toggle.addEventListener("click", function(event) {
                event.stopPropagation();
                const branch = this.parentElement.querySelector('.tree-branch');
                if (branch) {
                    const isOpen = branch.style.display === "block";
                    branch.style.display = isOpen ? "none" : "block";
                    this.textContent = isOpen ? "[+]" : "[-]";
                }
            });
        });

        filterInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                const filter = this.value.trim().toLowerCase();
                const items = document.querySelectorAll('.tree-root li');

                items.forEach(function(item) {
                    const text = item.textContent.toLowerCase();
                    const parentBranch = item.closest('ul.tree-branch');
                    const toggleBtn = parentBranch ? parentBranch.previousElementSibling.querySelector('.toggle-btn') : null;

                    if (filter === '') {
                        item.style.display = 'list-item';
                        if (parentBranch) parentBranch.style.display = 'block';
                        if (toggleBtn) toggleBtn.textContent = "[+]";
                    } else if (text.includes(filter)) {
                        item.style.display = 'list-item';
                        if (parentBranch) parentBranch.style.display = 'block';
                        if (toggleBtn) toggleBtn.textContent = "[-]";
                    } else {
                        item.style.display = 'none';
                    }
                });

                document.querySelectorAll('.tree-branch').forEach(function(branch) {
                    if (branch.querySelectorAll('li[style="display: list-item;"]').length > 0) {
                        branch.style.display = 'block';
                        const toggleBtn = branch.previousElementSibling.querySelector('.toggle-btn');
                        if (toggleBtn) toggleBtn.textContent = "[-]";
                    } else {
                        branch.style.display = 'none';
                    }
                });
            }
        });
    });
</script>